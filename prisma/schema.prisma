generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// משתמשים
model User {
  id        String   @id @default(cuid())
  name      String
  email     String?  @unique
  password  String?  // bcrypt hash
  role      String   @default("user") // admin, user
  image     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// טוקן לאיפוס סיסמה
model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// ישות דינמית - אדמין מגדיר
model Entity {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  icon        String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  fields      FieldDefinition[]
  records     DynamicRecord[]
}

// הגדרת שדה
model FieldDefinition {
  id          String   @id @default(cuid())
  entityId    String
  entity      Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)
  name        String
  label       String
  type        String   // text, number, email, phone, textarea, select, multiselect, date, datetime, checkbox, file, url, currency, user, relation
  options     String?  // JSON
  required    Boolean  @default(false)
  order       Int      @default(0)
  section     String?
  showInList  Boolean  @default(true)   // מופיע בראשי הטבלה
  showInCard  Boolean  @default(true)   // מופיע בכרטסת בלחיצה
  placeholder String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  files       RecordFile[]
  @@unique([entityId, name])
}

// רשומה דינמית
model DynamicRecord {
  id          String   @id @default(cuid())
  entityId    String
  entity      Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)
  data        Json
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  activities  DynamicActivity[]
  files       RecordFile[]
}

// קבצים מצורפים
model RecordFile {
  id                String   @id @default(cuid())
  recordId          String
  record            DynamicRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  fieldDefinitionId String?
  fieldDefinition   FieldDefinition? @relation(fields: [fieldDefinitionId], references: [id], onDelete: SetNull)
  filename          String
  url               String
  size              Int?
  createdAt         DateTime @default(now())
}

// פעילות לרשומות
model DynamicActivity {
  id          String   @id @default(cuid())
  recordId    String
  record      DynamicRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  type        String
  content     String?
  createdById String?
  createdAt   DateTime @default(now())
}

// תצוגות שמורות
model SavedView {
  id     String  @id @default(cuid())
  name   String
  filter String?
  sort   String?
  module String
}
